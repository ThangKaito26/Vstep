<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luyện thi Vstep cùng AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5; /* Indigo-600 */
            --primary-hover: #4338ca; /* Indigo-700 */
            --secondary: #10b981; /* Emerald-500 */
            --success: #22c55e; /* Green-500 */
            --warning: #f59e0b; /* Amber-500 */
            --danger: #ef4444; /* Red-500 */
            --text-primary: #1e293b; /* Slate-800 */
            --text-secondary: #475569; /* Slate-600 */
            --surface: #ffffff;
            --surface-alt: #f1f5f9; /* Slate-100 */
            --border: #e2e8f0; /* Slate-200 */
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        html.dark {
            --text-primary: #f1f5f9; /* Slate-100 */
            --text-secondary: #94a3b8; /* Slate-400 */
            --surface: #1e293b; /* Slate-800 */
            --surface-alt: #334155; /* Slate-700 */
            --border: #475569; /* Slate-600 */
        }
        
        html.dark body {
            background-color: #0f172a; /* Slate-900 */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23334155' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f8fafc; /* Slate-50 */
            color: var(--text-primary);
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e2e8f0' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            background-attachment: fixed;
        }

        .main-container { max-width: 1000px; margin: 2rem auto; padding: 0 1rem; }
        .header { text-align: center; margin-bottom: 2rem; }
        .header h1 { font-size: 2.5rem; font-weight: 700; }
        .header h1 span { background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header p { font-size: 1.125rem; color: var(--text-secondary); margin-top: 0.5rem; }
        
        .main-card { background-color: var(--surface); border-radius: 1.5rem; padding: 2rem; box-shadow: var(--shadow-lg); }
        .skill-section { border: 1px solid var(--border); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; transition: all 0.3s ease; }
        .skill-section:hover { border-color: var(--primary); box-shadow: var(--shadow); }
        .skill-title { font-size: 1.5rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1.25rem; display: flex; align-items: center; gap: 0.75rem; }
        .practice-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem; }
        .practice-btn { background-color: var(--surface-alt); border: 1px solid var(--border); border-radius: 0.75rem; padding: 0.75rem 1rem; text-align: center; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: block; width: 100%; }
        .practice-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow); border-color: var(--primary); color: var(--primary); }
        
        .content-area { margin-top: 2rem; }
        .loading-overlay { position: absolute; inset: 0; background: hsla(222, 47%, 11%, 0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; border-radius: 1.5rem; transition: opacity .3s ease; backdrop-filter: blur(4px); }
        .loading-spinner { width: 48px; height: 48px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem; }
        .loading-text { color: var(--primary-light); font-weight: 600; font-size: 1.125rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .info-card { background: var(--surface-alt); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .textarea-input { width: 100%; min-height: 200px; padding: 1rem; border-radius: 12px; border: 2px solid var(--border); font-size: 1rem; resize: vertical; background-color: var(--surface); color: var(--text-primary); }
        .textarea-input:focus { outline: none; border-color: var(--primary); }
        .primary-btn { background-color: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .primary-btn:hover { background-color: var(--primary-hover); }
        .primary-btn:disabled { background-color: var(--text-secondary); cursor: not-allowed; }
        .secondary-btn { background-color: var(--surface-alt); color: var(--text-primary); border: 1px solid var(--border); padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .secondary-btn:hover { background-color: var(--border); }

        .vstep-question { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .vstep-question-text { font-size: 1.1rem; font-weight: 500; margin-bottom: 1rem; line-height: 1.6; }
        .vstep-options { display: flex; flex-direction: column; gap: 0.75rem; }
        .vstep-option { text-align: left; padding: 0.75rem 1.25rem; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
        .vstep-option:hover { background: var(--primary-light); border-color: var(--primary); }
        .vstep-option.selected { background-color: var(--primary-light); border-color: var(--primary); }
        .vstep-option.correct { background-color: #dcfce7 !important; border-color: var(--success) !important; color: #166534 !important; font-weight: 600; }
        html.dark .vstep-option.correct { color: #bbf7d0 !important; }
        .vstep-option.incorrect { background-color: #fee2e2 !important; border-color: var(--danger) !important; color: #991b1b !important; }
        html.dark .vstep-option.incorrect { color: #fecaca !important; }
        
        /* Reading Layout Fix */
        .vstep-reading-layout { display: flex; flex-direction: column; }
        @media (min-width: 768px) {
            .vstep-reading-layout { flex-direction: row; gap: 1.5rem; max-height: 80vh; }
            .vstep-reading-passage { flex: 6; overflow-y: auto; padding-right: 1.5rem; border-right: 1px solid var(--border); line-height: 1.7; }
            .vstep-reading-questions { flex: 4; overflow-y: auto; }
        }

        .word-count { text-align: right; font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem; }
        .record-btn { background-color: var(--danger); }
        .record-btn.recording { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .hidden { display: none; }
        .card-title-alt { font-size: 1.1rem; font-weight: 600; margin-top: 1rem; margin-bottom: .5rem; color: var(--text-primary); }
        .score-circle { width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 2rem; font-weight: 700; border-width: 5px; border-style: solid; }
    </style>
</head>
<body class="transition-colors duration-300">

    <div class="main-container">
        <header class="header relative">
             <div class="absolute top-0 right-0">
                <button id="theme-toggle" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:text-gray-400">
                    <svg id="theme-toggle-dark-icon" class="hidden h-6 w-6" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden h-6 w-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <h1>Luyện thi <span>Vstep</span> cùng AI</h1>
            <p>Công cụ luyện thi Vstep toàn diện, được hỗ trợ bởi AI</p>
        </header>

        <div class="main-card">
            <div class="text-center mb-8">
                 <label for="vstepTopicInput" class="block font-semibold mb-2 text-lg text-gray-700 dark:text-gray-300">Nhập chủ đề để tạo bài luyện tập:</label>
                 <input type="text" id="vstepTopicInput" class="max-w-lg mx-auto w-full p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-center text-lg focus:border-primary focus:ring-primary" placeholder="Ví dụ: technology, environment, education...">
            </div>

            <!-- Listening Section -->
            <div class="skill-section">
                <h3 class="skill-title">🎧 Luyện Nghe <span class="text-sm font-normal text-gray-500 dark:text-gray-400 ml-auto">~40 phút</span></h3>
                <div class="practice-grid">
                    <button class="practice-btn" data-skill="listening" data-part="1">Phần 1: Thông báo ngắn</button>
                    <button class="practice-btn" data-skill="listening" data-part="2">Phần 2: Hội thoại</button>
                    <button class="practice-btn" data-skill="listening" data-part="3">Phần 3: Bài giảng</button>
                </div>
            </div>

            <!-- Reading Section -->
            <div class="skill-section">
                <h3 class="skill-title">📖 Luyện Đọc <span class="text-sm font-normal text-gray-500 dark:text-gray-400 ml-auto">60 phút</span></h3>
                <div class="practice-grid grid-cols-1">
                    <button class="practice-btn" data-skill="reading">Tạo bài đọc & câu hỏi</button>
                </div>
            </div>

            <!-- Writing Section -->
            <div class="skill-section">
                <h3 class="skill-title">✍️ Luyện Viết <span class="text-sm font-normal text-gray-500 dark:text-gray-400 ml-auto">60 phút</span></h3>
                <div class="practice-grid grid-cols-2">
                    <button class="practice-btn" data-skill="writing" data-task="1">Task 1: Viết thư</button>
                    <button class="practice-btn" data-skill="writing" data-task="2">Task 2: Viết luận</button>
                </div>
            </div>
            
            <!-- Speaking Section -->
            <div class="skill-section">
                <h3 class="skill-title">🎙️ Luyện Nói <span class="text-sm font-normal text-gray-500 dark:text-gray-400 ml-auto">~12 phút</span></h3>
                <div class="practice-grid">
                    <button class="practice-btn" data-skill="speaking" data-part="1">Phần 1: Tương tác xã hội</button>
                    <button class="practice-btn" data-skill="speaking" data-part="2">Phần 2: Thảo luận giải pháp</button>
                    <button class="practice-btn" data-skill="speaking" data-part="3">Phần 3: Phát triển chủ đề</button>
                </div>
            </div>
        </div>

        <div id="content-area" class="content-area"></div>
    </div>

    <script>
        // --- Theme Toggle Logic ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const applyTheme = () => {
            if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-toggle-light-icon').classList.remove('hidden');
                document.getElementById('theme-toggle-dark-icon').classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('theme-toggle-dark-icon').classList.remove('hidden');
                document.getElementById('theme-toggle-light-icon').classList.add('hidden');
            }
        };
        themeToggleBtn.addEventListener('click', function() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('color-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            applyTheme();
        });
        
        // --- Global State ---
        let isSpeaking = false;
        let recognition;
        let isRecording = false;
        let accumulatedTranscript = '';

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            applyTheme(); 
            const buttons = document.querySelectorAll('.practice-btn');
            buttons.forEach(button => {
                button.addEventListener('click', handlePracticeRequest);
            });
        });

        const contentArea = document.getElementById('content-area');

        function getTopic() {
            const topic = document.getElementById('vstepTopicInput').value.trim();
            if (!topic) {
                alert("Vui lòng nhập một chủ đề để tạo bài luyện tập.");
                return null;
            }
            return topic;
        }

        function showGeneratingScreen(skillName) {
            contentArea.innerHTML = `
                <div class="main-card relative">
                    <div class="loading-overlay flex">
                         <div class="loading-spinner"></div>
                         <p class="loading-text ml-4">AI đang tạo bài ${skillName}, vui lòng chờ trong giây lát...</p>
                    </div>
                    <div class="h-64"></div>
                </div>
            `;
            contentArea.scrollIntoView({ behavior: 'smooth' });
        }
        
        // --- Main Handler ---
        async function handlePracticeRequest(event) {
            const button = event.currentTarget;
            const skill = button.dataset.skill;
            const topic = getTopic();
            if (!topic) return;

            switch(skill) {
                case 'listening':
                    const partL = button.dataset.part;
                    showGeneratingScreen(`Luyện Nghe Phần ${partL}`);
                    try {
                        const data = await generateListeningTest(topic, partL);
                        renderListeningUI(data, partL);
                    } catch (error) {
                        handleError(error, 'nghe');
                    }
                    break;
                case 'reading':
                    showGeneratingScreen('Luyện Đọc');
                     try {
                        const data = await generateReadingTest(topic);
                        renderReadingUI(data);
                    } catch (error) {
                        handleError(error, 'đọc');
                    }
                    break;
                case 'writing':
                    const task = button.dataset.task;
                    showGeneratingScreen(`Luyện Viết Task ${task}`);
                    try {
                        const data = await generateWritingTest(topic, task);
                        renderWritingUI(data, task);
                    } catch (error) {
                        handleError(error, 'viết');
                    }
                    break;
                case 'speaking':
                    const partS = button.dataset.part;
                    showGeneratingScreen(`Luyện Nói Phần ${partS}`);
                    try {
                        const data = await generateSpeakingTest(topic, partS);
                        renderSpeakingUI(data, partS);
                    } catch (error) {
                        handleError(error, 'nói');
                    }
                    break;
            }
        }
        
        function handleError(error, skillName) {
             contentArea.innerHTML = `<div class="main-card text-center text-red-500 font-bold">Lỗi tạo bài ${skillName}: ${error.message}. Vui lòng thử lại với một chủ đề khác.</div>`;
             console.error(error);
        }

        // --- RENDERERS ---
        function renderListeningUI(data, part) {
            const partTitle = part === '1' ? 'Thông báo ngắn' : (part === '2' ? 'Hội thoại' : 'Bài giảng');
            let questionsHTML = '';
            
            data.forEach((section, sectionIndex) => {
                questionsHTML += `<div class="mb-8 p-4 border-l-4 border-indigo-200 dark:border-indigo-800" data-section-index="${sectionIndex}">`;
                questionsHTML += `<h4 class="text-xl font-semibold mb-4">Bài nghe ${sectionIndex + 1}</h4>`;
                section.questions.forEach((q) => {
                    questionsHTML += `
                        <div class="vstep-question" data-question-id="${q.id}" data-correct-answer="${q.correct_answer}">
                            <p class="vstep-question-text">${q.id}. ${q.question}</p>
                            <div class="vstep-options">
                                ${q.options.map((opt) => `<button class="vstep-option" data-value="${opt}">${opt}</button>`).join('')}
                            </div>
                        </div>
                    `;
                });
                questionsHTML += `</div>`;
            });

            contentArea.innerHTML = `
                <div class="main-card">
                    <h3 class="skill-title">🎧 Luyện Nghe - Phần ${part}: ${partTitle}</h3>
                    <div id="test-result-summary" class="hidden"></div>
                    <div class="info-card"><p class="font-semibold text-center">Đọc trước các câu hỏi. Nhấn "Bắt đầu nghe" để phát các đoạn âm thanh.</p></div>
                    <div id="listening-question-area">${questionsHTML}</div>
                    <div id="audio-status" class="text-center mt-4 font-semibold text-indigo-600 dark:text-indigo-400"></div>
                    <div class="text-center mt-6 flex justify-center gap-4">
                        <button id="startAudioBtn" class="secondary-btn">Bắt đầu nghe</button>
                        <button id="stopAudioBtn" class="secondary-btn hidden">Dừng phát âm</button>
                        <button id="submitTestBtn" class="primary-btn">Nộp bài</button>
                    </div>
                </div>
            `;
            
            attachOptionListeners('listening-question-area');

            const startBtn = document.getElementById('startAudioBtn');
            const stopBtn = document.getElementById('stopAudioBtn');
            const submitBtn = document.getElementById('submitTestBtn');
            const audioStatusEl = document.getElementById('audio-status');

            startBtn.addEventListener('click', () => {
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                startBtn.disabled = true;
                playAudioQueue(data.map(d => d.audio_script), audioStatusEl, () => {
                    stopBtn.classList.add('hidden');
                    startBtn.classList.remove('hidden');
                    startBtn.disabled = false;
                    startBtn.textContent = "Nghe lại";
                });
            });

            stopBtn.addEventListener('click', () => {
                speechSynthesis.cancel();
                isSpeaking = false;
                audioStatusEl.textContent = 'Đã dừng phát âm.';
                stopBtn.classList.add('hidden');
                startBtn.classList.remove('hidden');
                startBtn.disabled = false;
            });

            submitBtn.addEventListener('click', () => handleSubmitTest('listening-question-area'));
        }

        function renderReadingUI(data) {
            let questionsHTML = '';
            data.questions.forEach((q) => {
                questionsHTML += `
                    <div class="vstep-question" data-question-id="${q.id}" data-correct-answer="${q.correct_answer}">
                        <p class="vstep-question-text">${q.id}. ${q.question}</p>
                        <div class="vstep-options">
                            ${q.options.map((opt) => `<button class="vstep-option" data-value="${opt}">${opt}</button>`).join('')}
                        </div>
                    </div>
                `;
            });

            contentArea.innerHTML = `
                 <div class="main-card">
                    <h3 class="skill-title">📖 Luyện Đọc: ${data.title}</h3>
                    <div id="test-result-summary" class="hidden"></div>
                    <div class="vstep-reading-layout">
                        <div class="vstep-reading-passage">${data.passage.replace(/\n/g, '<br><br>')}</div>
                        <div class="vstep-reading-questions" id="reading-question-area">${questionsHTML}</div>
                    </div>
                    <div class="text-center mt-8">
                        <button id="submitTestBtn" class="primary-btn">Nộp bài</button>
                    </div>
                </div>
            `;
            attachOptionListeners('reading-question-area');
            document.getElementById('submitTestBtn').addEventListener('click', () => handleSubmitTest('reading-question-area'));
        }
        
        function renderWritingUI(data, task) {
             contentArea.innerHTML = `
                <div class="main-card">
                    <h3 class="skill-title">✍️ Luyện Viết - Task ${task}</h3>
                    <div class="info-card">
                        <p class="font-semibold text-lg">Đề bài:</p>
                        <p class="italic mt-2 text-gray-800 dark:text-gray-200 text-base leading-relaxed">${data.prompt.replace(/\n/g, '<br>')}</p>
                    </div>
                    <textarea id="writing-input" class="textarea-input" placeholder="Viết bài của bạn ở đây..."></textarea>
                    <p id="word-count" class="word-count">Số từ: 0</p>
                    <div class="text-center mt-6">
                        <button id="analyzeWritingBtn" class="primary-btn">Phân tích bài viết bằng AI</button>
                    </div>
                    <div id="writing-analysis-area" class="mt-4"></div>
                </div>
            `;
            const writingInput = document.getElementById('writing-input');
            const wordCount = document.getElementById('word-count');
            writingInput.addEventListener('input', () => {
                const count = writingInput.value.trim().split(/\s+/).filter(Boolean).length;
                wordCount.textContent = `Số từ: ${count}`;
            });
            document.getElementById('analyzeWritingBtn').addEventListener('click', async () => {
                const analysisArea = document.getElementById('writing-analysis-area');
                analysisArea.innerHTML = '<div class="loading-spinner mx-auto my-4"></div>';
                try {
                    const analysis = await analyzeWriting(writingInput.value, task);
                    analysisArea.innerHTML = `
                        <div class="info-card">
                            <h4 class="text-xl font-semibold mb-2">Phân tích của AI</h4>
                            <p class="mt-1"><strong>Mức độ hoàn thành:</strong> ${analysis.taskFulfillment}</p>
                            <p class="mt-1"><strong>Bố cục:</strong> ${analysis.organization}</p>
                            <p class="mt-1"><strong>Từ vựng:</strong> ${analysis.vocabulary}</p>
                            <p class="mt-1"><strong>Ngữ pháp:</strong> ${analysis.grammar}</p>
                            <p class="mt-2 text-lg"><strong>Điểm ước lượng:</strong> <span class="font-bold text-indigo-600 dark:text-indigo-400">${analysis.estimatedScore}/10</span></p>
                        </div>
                    `;
                } catch(e) {
                     analysisArea.innerHTML = `<p class="text-red-500 text-center font-bold">Lỗi phân tích bài viết: ${e.message}</p>`;
                }
            });
        }
        
        function renderSpeakingUI(data, part) {
            let contentHTML = '';
            let taskPrompt = '';
            switch(part) {
                case '1':
                    taskPrompt = `Chủ đề 1: ${data.topic1_title}. Chủ đề 2: ${data.topic2_title}`;
                    contentHTML = `
                        <div class="info-card">
                            <h4 class="card-title-alt text-lg">Chủ đề 1: ${data.topic1_title}</h4>
                            <ul class="list-disc list-inside ml-4 mt-2 space-y-1">${data.topic1_questions.map(q => `<li>${q}</li>`).join('')}</ul>
                        </div>
                         <div class="info-card">
                            <h4 class="card-title-alt text-lg">Chủ đề 2: ${data.topic2_title}</h4>
                            <ul class="list-disc list-inside ml-4 mt-2 space-y-1">${data.topic2_questions.map(q => `<li>${q}</li>`).join('')}</ul>
                        </div>
                    `;
                    break;
                case '2':
                    taskPrompt = `Tình huống: ${data.situation}`;
                    contentHTML = `
                        <div class="info-card">
                            <h4 class="card-title-alt text-lg">Tình huống:</h4>
                            <p class="mt-2">${data.situation}</p>
                            <h4 class="card-title-alt mt-4 text-lg">Các giải pháp gợi ý:</h4>
                            <ul class="list-disc list-inside ml-4 mt-2 space-y-1">${data.options.map(opt => `<li>${opt}</li>`).join('')}</ul>
                        </div>
                    `;
                    break;
                case '3':
                    taskPrompt = `Chủ đề: ${data.topic}`;
                    contentHTML = `
                        <div class="info-card">
                            <h4 class="card-title-alt text-lg">Chủ đề: ${data.topic}</h4>
                            <p class="mt-2">Sơ đồ gợi ý: ${data.idea_map.join(', ')}</p>
                            <h4 class="card-title-alt mt-4 text-lg">Câu hỏi phụ:</h4>
                            <ul class="list-disc list-inside ml-4 mt-2 space-y-1">${data.follow_up_questions.map(q => `<li>${q}</li>`).join('')}</ul>
                        </div>
                    `;
                    break;
            }

            contentArea.innerHTML = `
                <div class="main-card" data-task-prompt="${taskPrompt}">
                    <h3 class="skill-title">🎙️ Luyện Nói - Phần ${part}</h3>
                    <div id="speaking-analysis-area" class="hidden"></div>
                    ${contentHTML}
                    <div id="speaking-controls" class="text-center mt-6 flex justify-center items-center gap-4">
                        <button id="start-record-btn" class="primary-btn">Bắt đầu ghi âm</button>
                        <button id="stop-record-btn" class="primary-btn record-btn hidden">Nộp bài & Chấm điểm</button>
                    </div>
                    <div id="speaking-status" class="text-center mt-4 font-semibold"></div>
                </div>
            `;
            
            document.getElementById('start-record-btn').addEventListener('click', handleAdvancedRecording);
            document.getElementById('stop-record-btn').addEventListener('click', handleAdvancedRecording);
        }

        // --- SCORING & INTERACTION ---
        function attachOptionListeners(containerId) {
            const container = document.getElementById(containerId);
            container.addEventListener('click', (e) => {
                if (e.target.classList.contains('vstep-option')) {
                    const optionsContainer = e.target.parentElement;
                    // Deselect other options in the same question
                    optionsContainer.querySelectorAll('.vstep-option').forEach(btn => btn.classList.remove('selected'));
                    // Select the clicked option
                    e.target.classList.add('selected');
                }
            });
        }

        function handleSubmitTest(containerId) {
            const container = document.getElementById(containerId);
            const questions = container.querySelectorAll('.vstep-question');
            let score = 0;
            
            questions.forEach(q => {
                const correctAnswer = q.dataset.correctAnswer;
                const selectedOption = q.querySelector('.vstep-option.selected');
                const allOptions = q.querySelectorAll('.vstep-option');

                allOptions.forEach(opt => {
                    opt.disabled = true; // Disable all options
                    const optValue = opt.dataset.value;
                    // Highlight the correct answer
                    if (optValue === correctAnswer) {
                        opt.classList.add('correct');
                    }
                });

                if (selectedOption) {
                    if (selectedOption.dataset.value === correctAnswer) {
                        score++;
                    } else {
                        selectedOption.classList.add('incorrect');
                    }
                }
            });
            
            const summaryEl = document.getElementById('test-result-summary');
            const percentage = questions.length > 0 ? Math.round((score / questions.length) * 100) : 0;
            let scoreColor = 'var(--danger)';
            let scoreBg = '#fee2e2';
            let scoreText = '#991b1b';

            if (percentage >= 80) {
                scoreColor = 'var(--success)';
                scoreBg = '#dcfce7';
                scoreText = '#166534';
            } else if (percentage >= 50) {
                scoreColor = 'var(--warning)';
                scoreBg = '#fef3c7';
                scoreText = '#92400e';
            }

            summaryEl.innerHTML = `
                <div class="info-card border-2 border-indigo-500 text-center">
                    <h4 class="text-xl font-bold text-indigo-700 dark:text-indigo-300 mb-4">Kết quả bài làm</h4>
                    <div class="score-circle" style="border-color: ${scoreColor}; background-color: ${scoreBg}; color: ${scoreText};">
                        ${score}
                    </div>
                    <p class="text-xl font-bold">Bạn đã trả lời đúng ${score} trên tổng số ${questions.length} câu.</p>
                    <p class="text-lg text-gray-600 dark:text-gray-400">(Đạt ${percentage}%)</p>
                </div>
            `;
            summaryEl.classList.remove('hidden');
            summaryEl.scrollIntoView({ behavior: 'smooth' });

            document.getElementById('submitTestBtn').disabled = true;
        }


        // =================================================================
        // AI & GENERATION LOGIC
        // =================================================================
        
        async function callGemini(prompt, schema = null) {
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            if (schema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: schema
                };
            }
            const apiKey = ""; // The API key is provided by the environment at runtime.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({ error: { message: response.statusText } }));
                    console.error("API Error Response:", errorBody);
                    throw new Error(`Lỗi API: ${errorBody.error?.message || `Status ${response.status}`}`);
                }

                const result = await response.json();
                
                if (!result.candidates || result.candidates.length === 0) {
                     console.error("Response has no candidates:", result);
                     if (result.promptFeedback?.blockReason) {
                         throw new Error(`Yêu cầu bị chặn vì lý do: ${result.promptFeedback.blockReason}. Vui lòng thử chủ đề khác.`);
                     }
                     throw new Error('API không trả về kết quả hợp lệ.');
                }
                
                const text = result.candidates[0]?.content?.parts?.[0]?.text;

                if (text && text.trim()) {
                    if (schema) {
                        return JSON.parse(text);
                    }
                    return text; // Return as plain text if no schema
                } else {
                    console.error("API response has no text content:", result);
                    const finishReason = result.candidates[0]?.finishReason;
                    if (finishReason === 'SAFETY') {
                        throw new Error('Nội dung bị chặn vì lý do an toàn. Vui lòng thử một chủ đề khác.');
                    }
                    throw new Error('Cấu trúc phản hồi API không mong đợi hoặc văn bản trống.');
                }
            } catch (error) {
                console.error("Error in callGemini function:", error);
                if (error instanceof SyntaxError) {
                    throw new Error("Lỗi xử lý phản hồi từ AI (JSON không hợp lệ).");
                }
                throw error;
            }
        }
        
        // Updated prompts to include correct_answer
        async function generateListeningTest(topic, part) {
            const prompt = `Create a VSTEP Listening Part ${part} test based on the topic: "${topic}".
            - The language level must be B1-B2 CEFR.
            - If part is 1, return a JSON array of 8 objects. Each object must have "audio_script", and a "questions" array of 1 question object.
            - If part is 2, return a JSON array of 3 objects. Each object must have "audio_script", and a "questions" array of 4 question objects.
            - If part is 3, return a JSON array of 3 objects. Each object must have "audio_script", and a "questions" array of 5 question objects.
            - Each question object must have "id", "question", "options" (array of 4 strings), and "correct_answer" (the full string of the correct option).
            - The content must be strictly related to the topic.`;
            const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { audio_script: { type: "STRING" }, questions: { type: "ARRAY", items: { type: "OBJECT", properties: { id: { type: "NUMBER" }, question: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } }, correct_answer: { type: "STRING" } }, required: ["id", "question", "options", "correct_answer"] } } }, required: ["audio_script", "questions"] } };
            return await callGemini(prompt, schema);
        }

        async function generateReadingTest(topic) {
            const prompt = `Create a complete VSTEP Reading test based on the topic: "${topic}".
            Return a single JSON object with: "title", "passage" (~450-500 words, B1-B2 CEFR level), and a "questions" array of 10 objects. Each question must have "id", "question", "options" (array of 4 strings), and "correct_answer" (the full string of the correct option).`;
             const schema = { type: "OBJECT", properties: { title: { type: "STRING" }, passage: { type: "STRING" }, questions: { type: "ARRAY", items: { type: "OBJECT", properties: { id: { type: "NUMBER" }, question: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } }, correct_answer: { type: "STRING" } }, required: ["id", "question", "options", "correct_answer"] } } }, required: ["title", "passage", "questions"] };
            return await callGemini(prompt, schema);
        }

        async function generateWritingTest(topic, task) {
            const prompt = `Create a VSTEP Writing Task ${task} prompt based on the topic: "${topic}". Return a single JSON object with a "prompt" string.`;
            const schema = { type: "OBJECT", properties: { prompt: { type: "STRING" } }, required: ["prompt"] };
            return await callGemini(prompt, schema);
        }
        
        async function generateSpeakingTest(topic, part) {
            const prompt = `Create a VSTEP Speaking Part ${part} test based on the topic: "${topic}".
            - If Part 1, return a JSON object with "topic1_title", "topic1_questions" array (3 questions), "topic2_title", and "topic2_questions" array (3 questions).
            - If Part 2, return a JSON object with "situation" and "options" array (3 solutions).
            - If Part 3, return a JSON object with "topic", "idea_map" array (3-4 ideas), and "follow_up_questions" array (2-3 questions).`;
            let schema;
            if (part === '1') {
                schema = { type: "OBJECT", properties: { topic1_title: { type: "STRING" }, topic1_questions: { type: "ARRAY", items: { type: "STRING" } }, topic2_title: { type: "STRING" }, topic2_questions: { type: "ARRAY", items: { type: "STRING" } } }, required: ["topic1_title", "topic1_questions", "topic2_title", "topic2_questions"] };
            } else if (part === '2') {
                schema = { type: "OBJECT", properties: { situation: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } } }, required: ["situation", "options"] };
            } else { // Part 3
                schema = { type: "OBJECT", properties: { topic: { type: "STRING" }, idea_map: { type: "ARRAY", items: { type: "STRING" } }, follow_up_questions: { type: "ARRAY", items: { type: "STRING" } } }, required: ["topic", "idea_map", "follow_up_questions"] };
            }
            return await callGemini(prompt, schema);
        }
        
        async function analyzeWriting(writingText, task) {
            const prompt = `As a VSTEP examiner, analyze the following English text for Writing Task ${task}. Provide detailed feedback in VIETNAMESE on: Task Fulfillment, Organization, Vocabulary, and Grammar. Then, give an estimated score out of 10. Return a JSON object with keys "taskFulfillment", "organization", "vocabulary", "grammar", and "estimatedScore".
            Text: ${writingText || "(No submission)"}`;
             const schema = { type: "OBJECT", properties: { taskFulfillment: { type: "STRING" }, organization: { type: "STRING" }, vocabulary: { type: "STRING" }, grammar: { type: "STRING" }, estimatedScore: { type: "NUMBER" } }, required: ["taskFulfillment", "organization", "vocabulary", "grammar", "estimatedScore"] };
            return await callGemini(prompt, schema);
        }

        async function analyzeSpeaking(taskPrompt, transcript) {
            const prompt = `As a VSTEP speaking examiner, analyze the user's spoken response.
            - The task/question was: "${taskPrompt}"
            - The user's transcribed response is: "${transcript}"
            Provide a score out of 100 for overall performance. Also give detailed feedback in Vietnamese, including positive points and areas for improvement (pronunciation, fluency, grammar, vocabulary). Finally, provide a corrected version of the user's transcript if there are errors.
            Return a JSON object with keys: "score" (number), "feedback" (string), "corrected_transcript" (string), "positive_points" (string), "areas_for_improvement" (string).`;
            const schema = { type: "OBJECT", properties: { score: { type: "NUMBER" }, feedback: { type: "STRING" }, corrected_transcript: { type: "STRING" }, positive_points: { type: "STRING" }, areas_for_improvement: { type: "STRING" } }, required: ["score", "feedback", "corrected_transcript", "positive_points", "areas_for_improvement"] };
            return await callGemini(prompt, schema);
        }

        // --- Audio & Recording Helpers ---
        function speakText(text) {
            return new Promise((resolve, reject) => {
                if (!('speechSynthesis' in window)) {
                    console.error('Browser does not support speech synthesis.');
                    return reject('Speech synthesis not supported');
                }
                const utterance = new SpeechSynthesisUtterance(text);
                const voices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('en'));
                if (voices.length > 0) {
                    utterance.voice = voices.find(v => v.name.includes('Google') && v.name.includes('US')) || voices[0];
                    utterance.rate = 0.9;
                }
                utterance.onend = resolve;
                utterance.onerror = (e) => {
                    console.error("Speech synthesis error:", e);
                    reject(e);
                };
                speechSynthesis.speak(utterance);
            });
        }

        async function playAudioQueue(scripts, statusEl, onFinish) {
            isSpeaking = true;
            for (let i = 0; i < scripts.length; i++) {
                if (!isSpeaking) break; // Stop if user cancelled
                if (statusEl) statusEl.textContent = `Đang phát đoạn ${i + 1} / ${scripts.length}...`;
                try {
                    await speakText(scripts[i]);
                    if (isSpeaking && i < scripts.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1500));
                    }
                } catch (error) {
                    if (statusEl) statusEl.textContent = `Lỗi phát âm thanh.`;
                    break;
                }
            }
            if (isSpeaking) {
                if (statusEl) statusEl.textContent = 'Phần nghe đã kết thúc.';
            }
            isSpeaking = false;
            if (onFinish) onFinish();
        }

        function handleAdvancedRecording() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert('Trình duyệt của bạn không hỗ trợ nhận dạng giọng nói.');
                return;
            }

            const startBtn = document.getElementById('start-record-btn');
            const stopBtn = document.getElementById('stop-record-btn');
            const statusEl = document.getElementById('speaking-status');

            if (isRecording) { // This means the stop button was clicked
                if (recognition) {
                    recognition.stop();
                }
                return;
            }

            // This means the start button was clicked
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = true; // Keep listening
            recognition.interimResults = true; // Show interim results

            recognition.onstart = () => {
                isRecording = true;
                accumulatedTranscript = '';
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                statusEl.textContent = '🔴 Đang lắng nghe...';
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        accumulatedTranscript += event.results[i][0].transcript + ' ';
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                statusEl.textContent = `🔴 Đang lắng nghe... (Bạn đã nói: ${interimTranscript})`;
            };
            
            recognition.onend = async () => {
                isRecording = false;
                startBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                statusEl.textContent = 'Đã dừng ghi âm. Đang chấm điểm...';

                const taskPrompt = document.querySelector('.main-card[data-task-prompt]').dataset.taskPrompt;
                const analysisArea = document.getElementById('speaking-analysis-area');
                
                try {
                    const result = await analyzeSpeaking(taskPrompt, accumulatedTranscript);
                    analysisArea.innerHTML = `
                        <div class="pronunciation-score-card info-card">
                            <div class="score-circle">${result.score}</div>
                            <h4 class="card-title-alt">Bản ghi đã sửa</h4>
                            <p class="text-lg font-medium text-green-600 dark:text-green-400">"${result.corrected_transcript}"</p>
                            <h4 class="card-title-alt mt-4">Điểm tốt</h4>
                            <p>${result.positive_points}</p>
                            <h4 class="card-title-alt mt-4">Cần cải thiện</h4>
                            <p>${result.areas_for_improvement}</p>
                             <h4 class="card-title-alt mt-4">Nhận xét chung</h4>
                            <p>${result.feedback}</p>
                        </div>
                    `;
                    analysisArea.classList.remove('hidden');
                } catch(e) {
                    analysisArea.innerHTML = `<p class="text-red-500 text-center font-bold">Lỗi phân tích bài nói: ${e.message}</p>`;
                    analysisArea.classList.remove('hidden');
                }
                statusEl.textContent = 'Đã chấm điểm xong.';
            };
            
            recognition.onerror = (event) => {
                console.error("Recognition error:", event.error);
                statusEl.textContent = `Lỗi ghi âm: ${event.error}. Vui lòng thử lại.`;
                isRecording = false;
                startBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
            };

            recognition.start();
        }

    </script>
</body>
</html>
